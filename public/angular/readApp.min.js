var app=angular.module("readApp",["ngRoute","ngSanitize","ui.bootstrap"]);function config(t){t.when("/",{templateUrl:"topic/topic.html",controller:"topicCtrl",controllerAs:"vm"}).when("/topic/:topicId",{templateUrl:"topic/detail/topicDetail.html",controller:"topicDetailCtrl",caseInsensitiveMatch:true,controllerAs:"vm"}).when("/talks",{templateUrl:"talks/talks.html",controller:"talksCtrl",caseInsensitiveMatch:true,controllerAs:"vm"}).when("/talks/:talkid",{templateUrl:"talks/detail/talkDetail.html",controller:"talkDetailCtrl",caseInsensitiveMatch:true,controllerAs:"vm"}).when("/personal/:personal",{templateUrl:"personal/personal.html",controller:"personalCtrl",controllerAs:"vm",caseInsensitiveMatch:true}).when("/set/:user",{templateUrl:"set/set.html",controller:"setCtrl",controllerAs:"vm",caseInsensitiveMatch:true}).when("/books",{templateUrl:"books/books.html",controller:"booksCtrl",caseInsensitiveMatch:true,controllerAs:"vm"}).when("/book/:book",{templateUrl:"books/detail/bookDetail.html",controller:"bookDetailCtrl",caseInsensitiveMatch:true,controllerAs:"vm"}).when("/register",{templateUrl:"/auth/register/register.html",caseInsensitiveMatch:true,controller:"registerCtrl",controllerAs:"vm"}).when("/login",{templateUrl:"/auth/login/login.html",controller:"loginCtrl",controllerAs:"vm",caseInsensitiveMatch:true}).otherwise({redirectTo:"/"})}app.config(["$routeProvider",config]);angular.module("readApp").service("topicData",topicData).service("booksData",booksData).service("talksData",talksData);topicData.$inject=["$http","authentication"];booksData.$inject=["$http","authentication"];talksData.$inject=["$http","authentication"];function topicData(t,e){var o=function(e){return t.get("/api/topics/"+e)};var r=function(o){return t.post("/api/topics",o,{headers:{Authorization:"Bearer "+e.getToken()}})};var a=function(e){return t.get("/api/topic/"+e)};var n=function(o,r){return t.put("/api/c_onetopic/"+o,r,{headers:{Authorization:"Bearer "+e.getToken()}})};return{getByType:o,addPost:r,getOneTopic:a,addComments:n}}function booksData(t,e){var o=function(e){return t.get("/api/books/"+e)};var r=function(e){return t.get("/api/book/"+e)};var a=function(o){return t.post("/api/book",o,{headers:{Authorization:"Bearer "+e.getToken()}})};var n=function(o){return t.delete("/api/book/"+o,{headers:{Authorization:"Bearer "+e.getToken()}})};var i=function(o,r){return t.put("/api/book/"+o,r,{headers:{Authorization:"Bearer "+e.getToken()}})};var s=function(o){return t.put("/api/h_book/",o,{headers:{Authorization:"Bearer "+e.getToken()}})};var l=function(e){return t.get("/api/collections/"+e)};var c=function(e){return t.post("/api/uploadImg",e)};return{getBooks:o,getTheBook:r,addBook:a,removeBookById:n,updateBookById:i,manageBook:s,getCollections:l,uploadImage:c}}function talksData(t,e){var o=function(e){return t.get("/api/talks/"+e)};var r=function(o){return t.post("/api/talk",o,{headers:{Authorization:"Bearer "+e.getToken()}})};var a=function(o){return t.delete("/api/talk/"+o,{headers:{Authorization:"Bearer "+e.getToken()}})};var n=function(e){return t.get("/api/talk/"+e)};return{getTalks:o,addTalk:r,removeTalkById:a,getOneTalk:n}}angular.module("readApp").service("authentication",authentication);authentication.$inject=["$window","$http"];function authentication(t,e){var o=function(e){t.sessionStorage["read-token"]=e};var r=function(){return t.sessionStorage["read-token"]};var a=function(t){return e.post("/api/register",t).success(function(t){o(t.token)})};var n=function(t){return e.post("/api/login",t).success(function(t){o(t.token)})};var i=function(){t.sessionStorage.removeItem("read-token")};var s=function(){var e=r();if(e){var o=JSON.parse(t.atob(e.split(".")[1]));return o.exp>Date.now()/1e3}else{return false}};var l=function(t){return e.get("/api/person/"+t)};var c=function(){if(s()){var e=r(),o=JSON.parse(t.atob(e.split(".")[1]));return{_id:o._id,email:o.email,name:o.name}}};var u=function(t,o){return e.put("/api/user/"+t,o,{headers:{Authorization:"Bearer "+r()}})};return{saveToken:o,getToken:r,register:a,login:n,logout:i,isLoggedIn:s,currentUser:c,getPersoninfo:l,resetUserInfo:u}}angular.module("readApp").filter("formatDate",formatDate);function formatDate(){return function(t){var e=new Date(t),o=e.getDate(),r=e.getMonth()+1,a=e.getFullYear(),n=a+"/"+r+"/"+o;return n}}angular.module("readApp").directive("ratingStars",ratingStars);function ratingStars(){return{restrict:"EA",scope:{thisRating:"=rating"},templateUrl:"/main/directive/ratingStars/ratingStars.html"}}angular.module("readApp").directive("mainFooter",function(){return{restrict:"EA",templateUrl:"/main/directive/footer/footer.html"}});angular.module("readApp").directive("mainHeader",function(){return{restrict:"EA",templateUrl:"/main/directive/header/header.html",controller:"headerCtrl as navvm"}});angular.module("readApp").controller("headerCtrl",headerCtrl);headerCtrl.$inject=["$location","authentication"];function headerCtrl(t,e){var o=this;o.isLoggedIn=e.isLoggedIn();o.currentUser=e.currentUser();o.logout=function(){e.logout();t.path("/")}}angular.module("readApp").directive("mainEditTextarea",function(){return{restrict:"EA",templateUrl:"/main/directive/editor/editor.html",controller:"editTextCtrl as txtvm"}});angular.module("readApp").controller("editTextCtrl",editTextCtrl);editTextCtrl.$inject=["$routeParams","booksData","authentication"];function editTextCtrl(t,e,o){var r=this,a=t.book,n=o.currentUser();r.params={comment:"",commentUser:n.name,commentUserId:n._id};r.toSubCom=function(){if(r.textArea===""){console.log("请填写内容")}else{e.updateBookById(a,r.params).success(function(t){r.params.comment=""}).error(function(){})}};r.cancelSubCom=function(){}}angular.module("readApp").controller("topicCtrl",topicCtrl);topicCtrl.$inject=["topicData","authentication","$modal"];function topicCtrl(t,e,o){var r=this,a=e.currentUser();r.typeArr=["全部","读书","书评","求书","求索"];r._selected="全部";r.message="loading...";r.isLoggedIn=e.isLoggedIn();r.initTopicList=function(){t.getByType(r._selected).success(function(t){r.message=t.length>0?"":"还没有人发帖~~~";r.topicList=t}).error(function(){r.message="Sorry, something's gone wrong "})};r.createPost=function(){var t=o.open({templateUrl:"topic/modal/topicModal.html",controller:"topicModalCtrl as vm",resolve:{viewData:function(){return{title:"发布帖子",tags:r.typeArr,userName:a.name,userId:a._id}}}});t.result.then(function(t){r.topicList.push(t)})};r.selectTypeFn=function(t){r._selected=t;r.initTopicList()};r.initTopicList()}angular.module("readApp").controller("topicDetailCtrl",topicDetailCtrl);topicDetailCtrl.$inject=["$routeParams","topicData","authentication"];function topicDetailCtrl(t,e,o){var r=this,a=t.topicId,n=o.currentUser();r.isLoggedIn=o.isLoggedIn();r.param={comment:"",commentUser:n.name,commentUserId:n._id};r.isComment=false;r.message="Loading...";r.toComment=function(){r.isComment=!r.isComment};e.getOneTopic(a).success(function(t){r.oneTopicData=t;r.message=""}).error(function(){});r.addComments=function(){e.addComments(a,r.param).success(function(){r.isComment=false}).error(function(){})};r.cancelComments=function(){r.isComment=false};r.likeComment=function(){};r.disLikeComment=function(){}}angular.module("readApp").controller("topicModalCtrl",topicModalCtrl);topicModalCtrl.$inject=["topicData","$modalInstance","viewData"];function topicModalCtrl(t,e,o){var r=this;r.viewData=o;r.param={bookTitle:"",radioModel:"",content:"",userName:r.viewData.userName,userId:r.viewData.userId};r.onSubmit=function(){t.addPost(r.param).success(function(){}).error(function(){});r.modal.cancel()};r.selectTagFn=function(t){r.param.radioModel=t};r.modal={close:function(t){e.close(t)},cancel:function(){e.dismiss("cancel")}}}angular.module("readApp").controller("talksCtrl",talksCtrl);talksCtrl.$inject=["talksData","authentication"];function talksCtrl(t,e){var o=this;o.currentUser=e.currentUser();o.isLoggedIn=e.isLoggedIn();o.message="loading...";o.params={userName:o.currentUser.name,userId:o.currentUser._id,lift_piece:"",web_link:"",web_reason:"",diary_title:"",diary_content:"",radioModel:"",checkModel:[],type:""};o.tag_config=[{name:"电影",id:0},{name:"艺术",id:1},{name:"音乐",id:2},{name:"读书",id:3},{name:"时尚",id:4}];t.getTalks("all").success(function(t){o.message=t.length>0?"":"暂无数据";o.talksList=t}).error(function(){o.message="Sorry, something's gone wrong "});o.selectTagFn=function(t){var e=o.params.checkModel.indexOf(t.name);if(e>-1){o.params.checkModel.splice(e,1)}else{o.params.checkModel.push(t.name)}};o.selectWhich=function(t){o.nameType=window.event.target.id};o.submitText=function(e){o.params.type=e;t.addTalk(o.params).success(function(){o.nameType=""}).error(function(){})};o.cancelSubmit=function(){o.nameType=""};o.removeTalk=function(e){if(confirm("确定删除？")){t.removeTalkById(e).success(function(){for(var t=0;t<o.talksList.length;t++){if(o.talksList[t]._id==e){o.talksList.splice(o.talksList.indexOf(o.talksList[t]),1)}}})}}}angular.module("readApp").controller("talkDetailCtrl",talkDetailCtrl);talkDetailCtrl.$inject=["$routeParams","talksData"];function talkDetailCtrl(t,e){var o=this,r=t.talkid;o.message="Loading...";e.getOneTalk(r).success(function(t){o.oneTalkDate=t}).error(function(){})}angular.module("readApp").controller("personalCtrl",personalCtrl);personalCtrl.$inject=["$routeParams","talksData","booksData"];function personalCtrl(t,e,o){var r=this,a=t.personal;r.arrWordTalks=[];r.arrImgTalks=[];r.arrLinkTalks=[];r.arrDiaryTalks=[];e.getTalks(a).success(function(t){t.map(function(t){switch(t.type){case"word":r.arrWordTalks.push(t);break;case"image":r.arrImgTalks.push(t);break;case"link":r.arrLinkTalks.push(t);break;case"diary":r.arrDiaryTalks.push(t);break}})}).error(function(){r.message="Sorry, something's gone wrong "});o.getBooks(a).success(function(t){r.myBookLength=t.length;r.myBookList=t}).error(function(){});o.getCollections(a).success(function(t){r.thePersonInfo=t;r.w_BookLength=t.want_book.length;r.w_BookList=t.want_book}).error(function(){})}angular.module("readApp").controller("setCtrl",setCtrl);setCtrl.$inject=["authentication","$modal"];function setCtrl(t,e){var o=this;o.isPsw=false;o.user=t.currentUser();o.params={username:o.user.name||"",per_signature:"",old_psw:"",new_psw:""};o.resetPsw=function(){o.isPsw=!o.isPsw};o.resetInfo=function(){t.resetUserInfo(o.user._id,o.params).success(function(){})};o.setMoreInfo=function(){e.open({templateUrl:"set/modal/setModal.html",controller:"setModalCtrl as vm",resolve:{viewData:function(){return{userId:o.user._id}}}})}}angular.module("readApp").controller("setModalCtrl",setModalCtrl);setModalCtrl.$inject=["$modalInstance","viewData","authentication"];function setModalCtrl(t,e,o){var r=this;r.viewData=e;r.param={hobby:"",travels:"",brief:""};r.onSubmit=function(){r.formError="";if(!r.param.hobby||!r.param.travels||!r.param.brief){r.formError="请完成所有栏目!";return false}r.doUpdateUser(r.param);r.modal.cancel()};r.doUpdateUser=function(){o.resetUserInfo(r.viewData.userId,r.param).success(function(t){r.modal.close(t)}).error(function(){r.formError="添加失败，请再试一次"})};r.modal={close:function(e){t.close(e)},cancel:function(){t.dismiss("cancel")}}}angular.module("readApp").controller("booksCtrl",booksCtrl);booksCtrl.$inject=["booksData","$modal","$location","authentication"];function booksCtrl(t,e,o,r){var a=this;a.message="loading...";t.getBooks("all").success(function(t){a.message=t.length>0?"":"这里空空如也~~~";a.bookList=t}).error(function(){a.message="Sorry, something's gone wrong "});a.user=r.currentUser();a.isLoggedIn=r.isLoggedIn();a.currentPath=o.path();a.addBook=function(){var t=e.open({templateUrl:"books/modal/bookModal.html",controller:"bookModalCtrl as vm",resolve:{viewData:function(){return{title:"新增推荐"}}}});t.result.then(function(t){a.bookList.push(t)})};a.updateBook=function(t){e.open({templateUrl:"books/modal/bookModal.html",controller:"bookModalCtrl as vm",resolve:{viewData:function(){return{title:"更新信息",upBookId:t}}}})};a.removeBook=function(e){if(confirm("确定删除？")){t.removeBookById(e).success(function(){for(var t=0;t<a.bookList.length;t++){if(a.bookList[t]._id==e){a.bookList.splice(a.bookList.indexOf(a.bookList[t]),1)}}})}};a.handleStatus=function(e,o){t.manageBook({userId:a.user._id,bookId:e,bookImg:o}).success(function(t){console.log(t.message)}).error(function(t){})}}angular.module("readApp").controller("bookDetailCtrl",bookDetailCtrl);bookDetailCtrl.$inject=["$routeParams","booksData","authentication"];function bookDetailCtrl(t,e,o){var r=this,a=t.book;r.message="Loading...";r.isLoggedIn=o.isLoggedIn();r.currentUser=o.currentUser();r.isComment=false;e.getTheBook(a).success(function(t){if(typeof t==="object"&&t.title==="undefined"){r.message="暂无数据"}else{r.message=""}r.oneBookInfo=t}).error(function(){r.message="Sorry, something's gone wrong "});r.toComment=function(){r.isComment=!r.isComment};r.likeComment=function(){e.updateBookById(a,1).success(function(t){}).error(function(){})}}angular.module("readApp").controller("bookModalCtrl",bookModalCtrl);bookModalCtrl.$inject=["$modalInstance","viewData","booksData"];function bookModalCtrl(t,e,o){var r=this;r.viewData=e;r.formData={title:"",auth:"",press:"",ISBN:"",tags:"",rating:"",brief:"",book_img:""};r.onSubmit=function(){r.formError="";if(!r.formData.title||!r.formData.auth||!r.formData.press||!r.formData.ISBN||!r.formData.tags||!r.formData.rating||!r.formData.brief||!r.formData.book_img){r.formError="请完成所有栏目!";return false}else if(r.viewData.upBookId){r.doUpBook(r.formData)}else{r.doAddBook(r.formData)}r.modal.cancel()};r.doAddBook=function(t){o.addBook({title:t.title,auth:t.auth,press:t.press,ISBN:t.ISBN,tags:t.tags,rating:t.rating,brief:t.brief,book_img:t.book_img}).success(function(t){r.modal.close(t)}).error(function(){r.formError="添加失败，请再试一次"})};r.doUpBook=function(t){o.updateBookById(r.viewData.upBookId,{title:t.title,auth:t.auth,press:t.press,ISBN:t.ISBN,tags:t.tags,rating:t.rating,brief:t.brief,book_img:t.book_img}).success(function(t){r.modal.close(t)}).error(function(){r.formError="更新失败，请再试一次"})};r.uploadImg=function(){o.uploadImage({book_img:r.formData.book_img}).success(function(){}).error(function(){})};r.modal={close:function(e){t.close(e)},cancel:function(){t.dismiss("cancel")}}}angular.module("readApp").controller("registerCtrl",registerCtrl);registerCtrl.$inject=["$location","authentication"];function registerCtrl(t,e){var o=this;o.params={name:"",email:"",password:"",confirm_password:"",user_img:""};o.formError="";o.returnPage=t.search().page||"/";o.onSubmit=function(){if(!o.params.name||!o.params.email||!o.params.password||!o.params.confirm_password){o.formError="需要填完所有字段!";return false}else{o.doRegister()}};o.doRegister=function(){if(o.params.password!==o.params.confirm_password){o.formError="两次输入的密码不相同！"}else{e.register(o.params).error(function(t){o.formError=t}).then(function(){t.search("page",null);t.path(o.returnPage)})}};o.uploadImg=function(){e.uploadImg.success(function(t){o.params.user_img=t}).error(function(){console.log("图片上传出错！")})}}angular.module("readApp").controller("loginCtrl",loginCtrl);loginCtrl.$inject=["$location","authentication"];function loginCtrl(t,e){var o=this;o.params={email:"",password:""};o.onSubmit=function(){o.formError="";if(!o.params.email||!o.params.password){o.formError="请输入邮箱和密码!";return false}else{o.doLogin()}};o.doLogin=function(){o.formError="";e.login(o.params).error(function(){o.formError="登录出错了！"}).then(function(){t.path("/books")})}}angular.module("readApp").controller("loginCtrl",loginCtrl);loginCtrl.$inject=["$location","authentication"];function loginCtrl(t,e){var o=this;o.params={email:"",password:""};o.onSubmit=function(){o.formError="";if(!o.params.email||!o.params.password){o.formError="请输入邮箱和密码!";return false}else{o.doLogin()}};o.doLogin=function(){o.formError="";e.login(o.params).error(function(){o.formError="登录出错了！"}).then(function(){t.path("/books")})}}