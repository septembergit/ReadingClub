var app=angular.module("readApp",["ngRoute","ngSanitize","ui.bootstrap"]);function config(e){e.when("/",{templateUrl:"home/home.html",controller:"homeCtrl",controllerAs:"vm"}).when("/talks",{templateUrl:"talks/talks.html",controller:"talksCtrl",caseInsensitiveMatch:true,controllerAs:"vm"}).when("/talks/:talkid",{templateUrl:"talkDetail/talkDetail.html",controller:"talkDetailCtrl",caseInsensitiveMatch:true,controllerAs:"vm"}).when("/personal/:personal",{templateUrl:"personal/personal.html",controller:"personalCtrl",controllerAs:"vm",caseInsensitiveMatch:true}).when("/set/:user",{templateUrl:"set/set.html",controller:"setCtrl",controllerAs:"vm",caseInsensitiveMatch:true}).when("/books",{templateUrl:"books/books.html",controller:"booksCtrl",caseInsensitiveMatch:true,controllerAs:"vm"}).when("/book/:book",{templateUrl:"bookDetail/bookDetail.html",controller:"bookDetailCtrl",caseInsensitiveMatch:true,controllerAs:"vm"}).when("/register",{templateUrl:"/auth/register/register.html",caseInsensitiveMatch:true,controller:"registerCtrl",controllerAs:"vm"}).when("/login",{templateUrl:"/auth/login/login.html",controller:"loginCtrl",controllerAs:"vm",caseInsensitiveMatch:true}).otherwise({redirectTo:"/"})}app.config(["$routeProvider",config]);angular.module("readApp").service("$_uiNotify",$_uiNotify);function $_uiNotify(){}angular.module("readApp").service("topicData",topicData).service("booksData",booksData).service("talksData",talksData);topicData.$inject=["$http"];booksData.$inject=["$http","authentication"];talksData.$inject=["$http","authentication"];function topicData(e){var t=function(t){return e.get("/api/topics/"+t)};return{getByType:t}}function booksData(e,t){var r=e.get("/api/books");var o=function(t){return e.get("/api/book/"+t)};var a=function(r){return e.post("/api/book",r,{headers:{Authorization:"Bearer "+t.getToken()}})};var n=function(r){return e.delete("/api/book/"+r,{headers:{Authorization:"Bearer "+t.getToken()}})};var i=function(r,o){return e.put("/api/book/"+r,o,{headers:{Authorization:"Bearer "+t.getToken()}})};return{getBooks:r,getTheBook:o,addBook:a,removeBookById:n,updateBookById:i}}function talksData(e,t){var r=function(t){return e.get("/api/talks/"+t)};var o=function(r){return e.post("/api/talk",r,{headers:{Authorization:"Bearer "+t.getToken()}})};var a=function(r){return e.delete("/api/talk/"+r,{headers:{Authorization:"Bearer "+t.getToken()}})};return{getTalks:r,addTalk:o,removeTalkById:a}}angular.module("readApp").service("authentication",authentication);authentication.$inject=["$window","$http"];function authentication(e,t){var r=function(t){e.sessionStorage["read-token"]=t};var o=function(){return e.sessionStorage["read-token"]};var a=function(e){return t.post("/api/register",e).success(function(e){r(e.token)})};var n=function(e){return t.post("/api/login",e).success(function(e){r(e.token)})};var i=function(){e.sessionStorage.removeItem("read-token")};var s=function(){var t=o();if(t){var r=JSON.parse(e.atob(t.split(".")[1]));return r.exp>Date.now()/1e3}else{return false}};var l=function(e){return t.get("/api/person/"+e)};var c=function(){if(s()){var t=o(),r=JSON.parse(e.atob(t.split(".")[1]));return{_id:r._id,email:r.email,name:r.name}}};var u=function(e,r){return t.put("/api/user/"+e,r,{headers:{Authorization:"Bearer "+o()}})};var m=function(e){return t.delete("/api/user/"+e,{headers:{Authorization:"Bearer "+o()}})};return{saveToken:r,getToken:o,register:a,login:n,logout:i,isLoggedIn:s,currentUser:c,getPersoninfo:l,resetUserInfo:u,removeUser:m}}angular.module("readApp").filter("formatDate",formatDate);function formatDate(){return function(e){var t=new Date(e),r=t.getDate(),o=t.getMonth()+1,a=t.getFullYear(),n=a+"/"+o+"/"+r;return n}}angular.module("readApp").directive("ratingStars",ratingStars);function ratingStars(){return{restrict:"EA",scope:{thisRating:"=rating"},templateUrl:"/main/directive/ratingStars/ratingStars.html"}}angular.module("readApp").directive("mainFooter",function(){return{restrict:"EA",templateUrl:"/main/directive/footer/footer.html"}});angular.module("readApp").directive("mainHeader",function(){return{restrict:"EA",templateUrl:"/main/directive/header/header.html",controller:"headerCtrl as navvm"}});angular.module("readApp").controller("headerCtrl",headerCtrl);headerCtrl.$inject=["$location","authentication"];function headerCtrl(e,t){var r=this;r.isLoggedIn=t.isLoggedIn();r.currentUser=t.currentUser();r.logout=function(){t.logout();e.path("/")}}angular.module("readApp").directive("mainEditTextarea",function(){return{restrict:"EA",templateUrl:"/main/directive/editor/editor.html",controller:"editTextCtrl as txtvm"}});angular.module("readApp").controller("editTextCtrl",editTextCtrl);editTextCtrl.$inject=["$routeParams","booksData","authentication"];function editTextCtrl(e,t,r){var o=this,a=e.book,n=r.currentUser();o.params={comment:"",commentUser:n.name,commentUserId:n._id};o.toSubCom=function(){if(o.textArea===""){console.log("请填写内容")}else{t.updateBookById(a,o.params).success(function(e){o.params.comment=""}).error(function(){})}}}angular.module("readApp").controller("homeCtrl",homeCtrl);homeCtrl.$inject=["topicData"];function homeCtrl(e){var t=this;t.typeArr=["全部","读书","书评","求书","求索"];t._selected="全部";t.message="loading...";t.initTopicList=function(){e.getByType(t._selected).success(function(e){t.message=e.length>0?"":"暂无数据";t.topicList=e}).error(function(){t.message="Sorry, something's gone wrong "})};t.selectTypeFn=function(e){t._selected=e;t.initTopicList()};t.initTopicList()}angular.module("readApp").controller("talksCtrl",talksCtrl);talksCtrl.$inject=["talksData","authentication"];function talksCtrl(e,t){var r=this;r.currentUser=t.currentUser();r.isLoggedIn=t.isLoggedIn();r.message="loading...";r.params={userName:r.currentUser.name,userId:r.currentUser._id,lift_piece:"",web_link:"",web_reason:"",diary_title:"",diary_content:"",radioModel:"",checkModel:[],type:""};r.auth_config=[{name:"所有人可见",id:0},{name:"仅自己可见",id:1}];r.tag_config=[{name:"电影",id:0},{name:"艺术",id:1},{name:"音乐",id:2},{name:"读书",id:3},{name:"时尚",id:4}];e.getTalks("all").success(function(e){r.message=e.length>0?"":"暂无数据";r.talksList=e}).error(function(){r.message="Sorry, something's gone wrong "});r.selectTagFn=function(e){var t=r.params.checkModel.indexOf(e.name);if(t>-1){r.params.checkModel.splice(t,1)}else{r.params.checkModel.push(e.name)}};r.selectRadioFn=function(e){r.params.radioModel=r.tag_config[e].id};r.selectWhich=function(e){r.nameType=window.event.target.id};r.submitText=function(t){r.params.type=t;e.addTalk(r.params).success(function(e){r.nameType=""}).error(function(){})};r.removeTalk=function(t){if(confirm("确定删除？")){e.removeTalkById(t).success(function(){for(var e=0;e<r.talksList.length;e++){if(r.talksList[e]._id==t){r.talksList.splice(r.talksList.indexOf(r.talksList[e]),1)}}})}}}angular.module("readApp").controller("talkDetailCtrl",talkDetailCtrl);talkDetailCtrl.$inject=["$routeParams","booksData"];function talkDetailCtrl(e,t){var r=this,o=e.bookid;r.message="Loading..."}angular.module("readApp").controller("personalCtrl",personalCtrl);personalCtrl.$inject=["$routeParams","authentication","talksData"];function personalCtrl(e,t,r){var o=this,a=e.personal;t.getPersoninfo(a).success(function(e){o.thePersonInfo=e}).error(function(){o.message="Sorry, something's gone wrong "});r.getTalks(a).success(function(e){o.per_talks=e}).error(function(){o.message="Sorry, something's gone wrong "})}angular.module("readApp").controller("setCtrl",setCtrl);setCtrl.$inject=["$location","authentication"];function setCtrl(e,t){var r=this;r.isPsw=false;r.user=t.currentUser();r.params={username:r.user.name||"",per_signature:"",old_psw:"",new_psw:""};r.resetPsw=function(){r.isPsw=!r.isPsw};r.resetInfo=function(){t.resetUserInfo(r.user._id,r.params).success(function(){})};r.removeUser=function(){if(confirm("确定删除账号？")){t.removeUser(r.user._id).success(function(){t.logout();e.path("/")})}}}angular.module("readApp").controller("booksCtrl",booksCtrl);booksCtrl.$inject=["booksData","$modal","$location","authentication","$_uiNotify"];function booksCtrl(e,t,r,o,a){var n=this;n.message="loading...";e.getBooks.success(function(e){n.message=e.length>0?"":"这里空空如也~~~";n.bookList=e}).error(function(){n.message="Sorry, something's gone wrong "});n.user=o.currentUser();n.isLoggedIn=o.isLoggedIn();n.currentPath=r.path();n.addBook=function(){var e=t.open({templateUrl:"../bookModal/bookModal.html",controller:"bookModalCtrl as vm",resolve:{viewData:function(){return{title:"新增推荐"}}}});e.result.then(function(e){n.bookList.push(e)})};n.updateBook=function(e){t.open({templateUrl:"../bookModal/bookModal.html",controller:"bookModalCtrl as vm",resolve:{viewData:function(){return{title:"更新信息",upBookId:e}}}})};n.removeBook=function(t){if(confirm("确定删除？")){e.removeBookById(t).success(function(){for(var e=0;e<n.bookList.length;e++){if(n.bookList[e]._id==t){n.bookList.splice(n.bookList.indexOf(n.bookList[e]),1)}}})}};n.handleStatus=function(e){o.manageInfoList({userId:n.user._id,bookId:e}).success(function(){}).error(function(){})}}angular.module("readApp").controller("bookDetailCtrl",bookDetailCtrl);bookDetailCtrl.$inject=["$routeParams","booksData","authentication"];function bookDetailCtrl(e,t,r){var o=this,a=e.book;o.message="Loading...";o.isLoggedIn=r.isLoggedIn();o.currentUser=r.currentUser();o.isComment=false;t.getTheBook(a).success(function(e){if(typeof e==="object"&&e.title==="undefined"){o.message="暂无数据"}else{o.message=""}o.oneBookInfo=e}).error(function(){o.message="Sorry, something's gone wrong "});o.toComment=function(){o.isComment=!o.isComment};o.likeComment=function(){t.updateBookById(a,1).success(function(e){}).error(function(){})}}angular.module("readApp").controller("bookModalCtrl",bookModalCtrl);bookModalCtrl.$inject=["$modalInstance","viewData","booksData"];function bookModalCtrl(e,t,r){var o=this;o.viewData=t;o.formData={title:"",auth:"",press:"",ISBN:"",tags:"",rating:"",brief:""};o.onSubmit=function(){o.formError="";if(!o.formData.title||!o.formData.auth||!o.formData.press||!o.formData.ISBN||!o.formData.tags||!o.formData.rating||!o.formData.brief){o.formError="请完成所有栏目!";return false}else if(o.viewData.upBookId){o.doUpBook(o.formData)}else{o.doAddBook(o.formData)}o.modal.cancel()};o.doAddBook=function(e){r.addBook({title:e.title,auth:e.auth,press:e.press,ISBN:e.ISBN,tags:e.tags,rating:e.rating,brief:e.brief}).success(function(e){o.modal.close(e)}).error(function(){o.formError="添加失败，请再试一次"})};o.doUpBook=function(e){r.updateBookById(o.viewData.upBookId,{title:e.title,auth:e.auth,press:e.press,ISBN:e.ISBN,tags:e.tags,rating:e.rating,brief:e.brief}).success(function(e){o.modal.close(e)}).error(function(){o.formError="更新失败，请再试一次"})};o.modal={close:function(t){e.close(t)},cancel:function(){e.dismiss("cancel")}}}angular.module("readApp").controller("registerCtrl",registerCtrl);registerCtrl.$inject=["$location","authentication"];function registerCtrl(e,t){var r=this;r.params={name:"",email:"",password:"",confirm_password:"",user_img:""};r.formError="";r.returnPage=e.search().page||"/";r.onSubmit=function(){if(!r.params.name||!r.params.email||!r.params.password||!r.params.confirm_password){r.formError="需要填完所有字段!";return false}else{r.doRegister()}};r.doRegister=function(){if(r.params.password!==r.params.confirm_password){r.formError="两次输入的密码不相同！"}else{t.register(r.params).error(function(e){r.formError=e}).then(function(){e.search("page",null);e.path(r.returnPage)})}};r.uploadImg=function(){t.uploadImg.success(function(e){r.params.user_img=e}).error(function(){console.log("图片上传出错！")})}}angular.module("readApp").controller("loginCtrl",loginCtrl);loginCtrl.$inject=["$location","authentication"];function loginCtrl(e,t){var r=this;r.params={email:"",password:""};r.onSubmit=function(){r.formError="";if(!r.params.email||!r.params.password){r.formError="请输入邮箱和密码!";return false}else{r.doLogin()}};r.doLogin=function(){r.formError="";t.login(r.params).error(function(){r.formError="登录出错了！"}).then(function(){e.path("/books")})}}