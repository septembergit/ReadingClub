var app=angular.module("readApp",["ngRoute","ngSanitize","ui.bootstrap"]);function config(t){t.when("/",{templateUrl:"home/home.html",controller:"homeCtrl",controllerAs:"vm"}).when("/discuss",{templateUrl:"discuss/discuss.html",controller:"discussCtrl",caseInsensitiveMatch:true,controllerAs:"vm"}).when("/personal",{templateUrl:"personal/personal.html",controller:"personalCtrl",controllerAs:"vm",caseInsensitiveMatch:true}).when("/books",{templateUrl:"books/books.html",controller:"booksCtrl",caseInsensitiveMatch:true,controllerAs:"vm"}).when("/book/:bookid",{templateUrl:"bookDetail/bookDetail.html",controller:"bookDetailCtrl",caseInsensitiveMatch:true,controllerAs:"vm"}).when("/register",{templateUrl:"/auth/register/register.html",caseInsensitiveMatch:true,controller:"registerCtrl",controllerAs:"vm"}).when("/login",{templateUrl:"/auth/login/login.html",controller:"loginCtrl",controllerAs:"vm",caseInsensitiveMatch:true}).otherwise({redirectTo:"/"})}app.config(["$routeProvider",config]);angular.module("readApp").controller("homeCtrl",homeCtrl);homeCtrl.$inject=["topicData"];function homeCtrl(t){var r=this;r.data=t}angular.module("readApp").service("topicData",topicData).service("booksData",booksData).service("talksData",talksData);topicData.$inject=["$http"];booksData.$inject=["$http","authentication"];talksData.$inject=["$http"];function topicData(t){return[{title:"《明朝那些事儿》",type:"书评",visitedCount:2,commentCount:1,img:"",_user:"子不语"},{title:"《心理罪》",type:"读书",visitedCount:2,commentCount:1,img:"",_user:"吾不知"}]}function booksData(t,r){var e=function(){return[{img:"",_id:0x3f28cb71571c7,title:"深入浅出 Node.js",info:"朴灵 / 人民邮电出版社 / 2013-2-1 / CNY69.00",rating:3,tags:["node","深入浅出"],brief:"nnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnn",IBSN:"",comments:["不错不错","很好的一本书"]},{img:"",_id:2,title:"程序员修炼之道",info:"马维达",rating:5,tags:["程序人生","软件开发"]}]};var n=function(){return{img:"",_id:1,title:"深入浅出 Node.js",info:"朴灵 / 人民邮电出版社 / 2013-2-1 / CNY69.00",rating:3,tags:["node","深入浅出"],brief:"nnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnn",IBSN:"不知道IBSN是什么啊",comments:["不错不错","很好的一本书"]}};var o=function(t){};var a=function(t){};return{getBooks:e,getbookById:n,addBook:o,removeBookById:a}}function talksData(t){var r=function(){return[{title:"深入浅出 PHP",info:"朴灵 / 人民邮电出版社 / 2013-2-1 / CNY69.00",rating:3,tags:["node","深入浅出"]},{title:"程序员修炼之道",info:"马维达",rating:5,tags:["程序人生","软件开发"]}]};var e=function(t){};return{getTalks:r,removeDisById:e}}angular.module("readApp").service("authentication",authentication);authentication.$inject=["$window","$http"];function authentication(t,r){var e=function(r){t.localStorage["read-token"]=r};var n=function(){return t.localStorage["read-token"]};var o=function(t){return r.post("/api/register",t).success(function(t){e(t.token)})};var a=function(t){return r.post("/api/login",t).success(function(t){e(t.token)})};var i=function(){t.localStorage.removeItem("read-token")};var l=function(){var r=n();if(r){var e=JSON.parse(t.atob(r.split(".")[1]));return e.exp>Date.now()/1e3}else{return false}};var s=function(){if(l()){var r=n(),e=JSON.parse(t.atob(r.split(".")[1]));return{email:e.email,name:e.name}}};return{saveToken:e,getToken:n,register:o,login:a,logout:i,isLoggedIn:l,currentUser:s}}angular.module("readApp").filter("formatDate",formatDate);function formatDate(){return function(t){var r=new Date(t),e=r.getDate(),n=["1","2","3","4","5","6","7","8","9","10","11","12"],o=n[r.getMonth()],a=r.getFullYear(),i=a+"/"+o+"/"+e;return i}}angular.module("readApp").directive("ratingStars",ratingStars);function ratingStars(){return{restrict:"EA",scope:{thisRating:"=rating"},templateUrl:"/main/directive/ratingStars/ratingStars.html"}}angular.module("readApp").directive("mainFooter",function(){return{restrict:"EA",templateUrl:"/main/directive/footer/footer.html"}});angular.module("readApp").directive("mainHeader",function(){return{restrict:"EA",templateUrl:"/main/directive/header/header.html"}});angular.module("readApp").controller("headerCtrl",headerCtrl);headerCtrl.$inject=["$location","authentication"];function headerCtrl(t,r){var e=this;e.currentPath=t.path();e.isLoggedIn=r.isLoggedIn();e.currentUser=r.currentUser();e.logout=function(){r.logout();t.path("/")};e.witchLi=function(){}}angular.module("readApp").controller("discussCtrl",discussCtrl);discussCtrl.$inject=["talksData","$location","authentication"];function discussCtrl(t,r,e){var n=this;n.talksList=t.getTalks();n.user=e.currentUser();n.isLoggedIn=e.isLoggedIn();n.currentPath=r.path()}angular.module("readApp").controller("personalCtrl",personalCtrl);personalCtrl.$inject=["authentication"];function personalCtrl(t){var r=this;r.currentUser={email:"test@163.com",name:"test"};r.title=r.currentUser.name+"的读书主页";r.whichTitle=function(){switch(window.event.target.text){case"读书主页":break;case"在读":r.title="我的在读（"+r.currentUser.name+"）";break;case"想读":r.title="我想读的书（"+r.currentUser.name+"）";break;case"读过":r.title="我读过的书（"+r.currentUser.name+"）";break;case"话题":r.title="我的话题（"+r.currentUser.name+"）";break}}}angular.module("readApp").controller("booksCtrl",booksCtrl);booksCtrl.$inject=["booksData","$modal","$location","authentication"];function booksCtrl(t,r,e,n){var o=this;o.books=t.getBooks();o.user=n.currentUser();o.isLoggedIn=n.isLoggedIn();o.currentPath=e.path();o.popupForm=function(){var t=r.open({templateUrl:"../bookModal/bookModal.html",controller:"bookModalCtrl as vm",resolve:{viewData:function(){return{title:"新增推荐"}}}});t.result.then(function(t){o.books.push(t)})};o.removeBook=function(r){if(confirm("确定删除？")){t.removeBookById(r).success(function(){for(var t=0;t<o.books.length;t++){if(o.books[t]._id==r){o.books.splice(o.books.indexOf(o.books[t]),1)}}})}}}angular.module("readApp").controller("bookDetailCtrl",bookDetailCtrl);bookDetailCtrl.$inject=["$routeParams","booksData"];function bookDetailCtrl(t,r){var e=this,n=t.bookid;e.book=r.getbookById()}angular.module("readApp").controller("bookModalCtrl",bookModalCtrl);bookModalCtrl.$inject=["$modalInstance","viewData","booksData"];function bookModalCtrl(t,r,e){var n=this;n.viewData=r;n.formData={title:"",info:"",ISBN:"",tags:"",rating:"",brief:""};n.onSubmit=function(){n.formError="";if(!n.formData.title||!n.formData.info||!n.formData.ISBN||!n.formData.tags||!n.formData.rating||!n.formData.brief){n.formError="请完成所有栏目!";return false}else{n.doAddBook(n.formData);n.modal.cancel()}};n.doAddBook=function(t){e.addBook({title:t.title,info:t.info,ISBN:t.ISBN,tags:t.tags,rating:t.rating,brief:t.brief,img:t.img}).success(function(t){n.modal.close(t)}).error(function(){n.formError="添加失败，请再试一次"});return false};n.modal={close:function(r){t.close(r)},cancel:function(){t.dismiss("cancel")}}}angular.module("readApp").controller("registerCtrl",registerCtrl);registerCtrl.$inject=["$location","authentication"];function registerCtrl(t,r){var e=this;e.params={name:"",email:"",password:"",confirm_password:""};e.formError="";e.returnPage=t.search().page||"/";e.onSubmit=function(){if(!e.params.name||!e.params.email||!e.params.password||!e.params.confirm_password){e.formError="需要填完所有字段!";return false}else{e.doRegister()}};e.doRegister=function(){if(e.params.password!==e.params.confirm_password){e.formError="两次输入的密码不相同！"}else{r.register(e.params).error(function(t){e.formError=t}).then(function(){t.search("page",null);t.path(e.returnPage)})}}}angular.module("readApp").controller("loginCtrl",loginCtrl);loginCtrl.$inject=["$location","authentication"];function loginCtrl(t,r){var e=this;e.params={email:"",password:""};e.returnPage=t.search().page||"/";e.onSubmit=function(){e.formError="";if(!e.params.email||!e.params.password){e.formError="请输入邮箱和密码!";return false}else{e.doLogin()}};e.doLogin=function(){e.formError="";r.login(e.params).error(function(t){e.formError=t.message}).then(function(){t.search("page",null);t.path(e.returnPage)})}}