(function(){angular.module("readApp",["ngRoute","ngSanitize","ui.bootstrap"]);function o(o,e){o.when("/",{templateUrl:"home/home.view.html",controller:"homeCtrl",controllerAs:"vm"}).when("/about",{templateUrl:"about/about.html",controller:"aboutCtrl",caseInsensitiveMatch:true,controllerAs:"vm"}).when("/books",{templateUrl:"books/books.html",controller:"booksCtrl",caseInsensitiveMatch:true,controllerAs:"vm"}).when("/book/:bookid",{templateUrl:"bookDetail/bookDetail.html",controller:"bookDetailCtrl",caseInsensitiveMatch:true,controllerAs:"vm"}).when("/register",{templateUrl:"/auth/register/register.view.html",caseInsensitiveMatch:true,controller:"registerCtrl",controllerAs:"vm"}).when("/login",{templateUrl:"/auth/login/login.view.html",controller:"loginCtrl",controllerAs:"vm",caseInsensitiveMatch:true}).otherwise({redirectTo:"/"});e.html5Mode(true)}angular.module("readApp").config(["$routeProvider","$locationProvider",o])})();angular.module("readApp").controller("homeCtrl",homeCtrl);homeCtrl.$inject=["topicData","userData"];function homeCtrl(o,e){var t=this;t.message="loading...";o.success(function(o){t.message=o.length>0?"":"暂无数据";t.data=o}).error(function(o){console.log(o);t.message="Sorry, something's gone wrong "});t.user=e}angular.module("readApp").service("topicData",topicData).service("booksData",booksData).service("userData",userData);topicData.$inject=["$http"];function topicData(o){return o.get("/api/topics")}booksData.$inject=["$http","authentication"];function booksData(o,e){var t=o.get("/api/books");var r=function(e){return o.get("/api/book/"+e)};var n=function(t){return o.post("/api/book",t,{headers:{Authorization:"Bearer "+e.getToken()}})};var a=function(e){return o.delete("/api/book/"+e)};return{getBooks:t,getbookById:r,addBook:n,removeBookById:a}}function userData(){return{userName:"stoneniqiu"}}(function(){angular.module("readApp").service("authentication",o);o.$inject=["$window","$http"];function o(o,e){var t=function(e){o.localStorage["read-token"]=e};var r=function(){return o.localStorage["read-token"]};var n=function(o){return e.post("/api/register",o).success(function(o){t(o.token)})};var a=function(o){return e.post("/api/login",o).success(function(o){t(o.token)})};var i=function(){o.localStorage.removeItem("read-token")};var l=function(){var e=r();if(e){var t=JSON.parse(o.atob(e.split(".")[1]));return t.exp>Date.now()/1e3}else{return false}};var s=function(){if(l()){var e=r();var t=JSON.parse(o.atob(e.split(".")[1]));return{email:t.email,name:t.name}}};return{saveToken:t,getToken:r,register:n,login:a,logout:i,isLoggedIn:l,currentUser:s}}})();angular.module("readApp").filter("formatDate",formatDate);function formatDate(){return function(o){var e=new Date(o);var t=e.getDate();var r=["1","2","3","4","5","6","7","8","9","10","11","12"];var n=r[e.getMonth()];var a=e.getFullYear();var i=a+"/"+n+"/"+t;return i}}angular.module("readApp").directive("ratingStars",ratingStars);function ratingStars(){return{restrict:"EA",scope:{thisRating:"=rating"},templateUrl:"/common/directive/ratingStars/ratingStars.template.html"}}(function(){angular.module("readApp").directive("footerNav",o);function o(){return{restrict:"EA",templateUrl:"/common/directive/footer/footer.html"}}})();(function(){angular.module("readApp").directive("navigation",o);function o(){return{restrict:"EA",templateUrl:"/common/directive/navigation/navigation.html",controller:"navigationCtrl as navvm"}}})();(function(){angular.module("readApp").controller("navigationCtrl",o);o.$inject=["$location","authentication"];function o(o,e){var t=this;t.currentPath=o.path();t.isLoggedIn=e.isLoggedIn();t.currentUser=e.currentUser();t.logout=function(){e.logout();o.path("/")}}})();(function(){angular.module("readApp").controller("aboutCtrl",o);function o(){var o=this;o.title="<b>ReadingClub</b>";o.user={userName:"stoneniqiu"};o.list=["第一期   《失控》             -- 上海-stoneniqiu","第二期   《代码整洁之道》     -- 上海-stoneniqiu","第三期   《女人的起源》       -- 长沙-素情","第四期   《数学之美》         -- 广州_Watery.D.Lotus","第五期   《卓有成效的管理者》 -- 北京-卡萨布兰卡","第六期   《异类》             -- 上海-stoneniqiu","第七期   《设计心理学》       -- 北京--彦圣","第八期   《乌合之众》         -- 广州_Watery.D.Lotus & 上海_stoneniqiu","第九期   《国富论》           -- 上海-stoneniqiu","第十期   《少有人走的路》     -- 深圳-一路风景","第十一期 《程序员修炼之道》   -- stoneniqiu","第十二期 《性格色彩》         -- 上海_星空"]}})();(function(){angular.module("readApp").controller("booksCtrl",o);o.$inject=["booksData","$modal","$location","authentication"];function o(o,e,t,r){var n=this;n.message="loading...";o.getBooks.success(function(o){n.message=o.length>0?"":"暂无数据";n.books=o}).error(function(o){console.log(o);n.message="Sorry, something's gone wrong "});n.user=r.currentUser();n.isLoggedIn=r.isLoggedIn();n.currentPath=t.path();n.popupForm=function(){var o=e.open({templateUrl:"/bookModal/bookModal.html",controller:"bookModalCtrl as vm",resolve:{viewData:function(){return{title:"新增推荐"}}}});o.result.then(function(o){n.books.push(o)})};n.removeBook=function(e){if(confirm("确定删除？")){o.removeBookById(e).success(function(){for(var o=0;o<n.books.length;o++){if(n.books[o]._id==e){n.books.splice(n.books.indexOf(n.books[o]),1)}}})}}}})();(function(){angular.module("readApp").controller("bookDetailCtrl",o);o.$inject=["$routeParams","booksData","$modal","userData"];function o(o,e,t,r){var n=this;var a=o.bookid;e.getbookById(a).success(function(o){n.book=o}).error(function(o){console.log(o);n.message="Sorry, something's gone wrong "});n.user=r}})();(function(){angular.module("readApp").controller("bookModalCtrl",o);o.$inject=["$modalInstance","viewData","booksData"];function o(o,e,t){var r=this;r.viewData=e;r.onSubmit=function(){r.formError="";if(!r.formData.title||!r.formData.rating||!r.formData.brief||!r.formData.info||!r.formData.ISBN){r.formError="请完成所有栏目!";return false}else{console.log(r.formData);r.doAddBook(r.formData);return false}};r.doAddBook=function(o){t.addBook({title:o.title,info:o.info,ISBN:o.ISBN,brief:o.brief,tags:o.tags,img:o.img,rating:o.rating}).success(function(o){console.log("success!");r.modal.close(o)}).error(function(o){r.formError="添加失败，请再试一次"});return false};r.modal={close:function(e){o.close(e)},cancel:function(){o.dismiss("cancel")}}}})();(function(){angular.module("readApp").controller("registerCtrl",o);o.$inject=["$location","authentication"];function o(o,e){var t=this;t.credentials={name:"",email:"",password:""};t.returnPage=o.search().page||"/";t.onSubmit=function(){t.formError="";if(!t.credentials.name||!t.credentials.email||!t.credentials.password){t.formError="需要填完所有字段!";return false}else{t.doRegister()}};t.doRegister=function(){t.formError="";e.register(t.credentials).error(function(o){t.formError=o}).then(function(){o.search("page",null);o.path(t.returnPage)})}}})();(function(){angular.module("readApp").controller("loginCtrl",o);o.$inject=["$location","authentication"];function o(o,e){var t=this;t.credentials={email:"",password:""};t.returnPage=o.search().page||"/";t.onSubmit=function(){t.formError="";if(!t.credentials.email||!t.credentials.password){t.formError="请输入邮箱和密码!";return false}else{t.doLogin()}};t.doLogin=function(){t.formError="";e.login(t.credentials).error(function(o){t.formError=o.message}).then(function(){o.search("page",null);o.path(t.returnPage)})}}})();