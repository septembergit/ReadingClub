var app=angular.module("readApp",["ngRoute","ngSanitize","ui.bootstrap"]);function config(e){e.when("/",{templateUrl:"home/home.html",controller:"homeCtrl",controllerAs:"vm"}).when("/discuss",{templateUrl:"discuss/discuss.html",controller:"discussCtrl",caseInsensitiveMatch:true,controllerAs:"vm"}).when("/personal",{templateUrl:"personal/personal.html",controller:"personalCtrl",controllerAs:"vm",caseInsensitiveMatch:true}).when("/books",{templateUrl:"books/books.html",controller:"booksCtrl",caseInsensitiveMatch:true,controllerAs:"vm"}).when("/book/:bookid",{templateUrl:"bookDetail/bookDetail.html",controller:"bookDetailCtrl",caseInsensitiveMatch:true,controllerAs:"vm"}).when("/register",{templateUrl:"/auth/register/register.html",caseInsensitiveMatch:true,controller:"registerCtrl",controllerAs:"vm"}).when("/login",{templateUrl:"/auth/login/login.html",controller:"loginCtrl",controllerAs:"vm",caseInsensitiveMatch:true}).otherwise({redirectTo:"/"})}app.config(["$routeProvider",config]);angular.module("readApp").controller("homeCtrl",homeCtrl);homeCtrl.$inject=["topicData"];function homeCtrl(e){var t=this;t.message="loading...";e.success(function(e){t.message=e.length>0?"":"暂无数据";t.data=e}).error(function(){t.message="Sorry, something's gone wrong "})}angular.module("readApp").service("topicData",topicData).service("booksData",booksData).service("talksData",talksData);topicData.$inject=["$http"];booksData.$inject=["$http","authentication"];talksData.$inject=["$http"];function topicData(e){return e.get("/api/topics")}function booksData(e,t){var r=e.get("/api/books");var o=function(t){e.post("/api/books",t).success(function(e){return e})};var a=function(r){return e.post("/api/book",r,{headers:{Authorization:"Bearer "+t.getToken()}})};var n=function(r){return e.delete("/api/book/"+r,{Authorization:"Bearer "+t.getToken()})};return{getBooks:r,getbookById:o,addBook:a,removeBookById:n}}function talksData(e){var t=function(){};var r=function(e){};return{getTalks:t,removeDisById:r}}angular.module("readApp").service("authentication",authentication);authentication.$inject=["$window","$http"];function authentication(e,t){var r=function(t){e.localStorage["read-token"]=t};var o=function(){return e.localStorage["read-token"]};var a=function(e){return t.post("/api/register",e).success(function(e){r(e.token)})};var n=function(e){return t.post("/api/login",e).success(function(e){r(e.token)})};var i=function(){e.localStorage.removeItem("read-token")};var s=function(){var t=o();if(t){var r=JSON.parse(e.atob(t.split(".")[1]));return r.exp>Date.now()/1e3}else{return false}};var l=function(){if(s()){var t=o(),r=JSON.parse(e.atob(t.split(".")[1]));return{email:r.email,name:r.name}}};return{saveToken:r,getToken:o,register:a,login:n,logout:i,isLoggedIn:s,currentUser:l}}angular.module("readApp").filter("formatDate",formatDate);function formatDate(){return function(e){var t=new Date(e),r=t.getDate(),o=["1","2","3","4","5","6","7","8","9","10","11","12"],a=o[t.getMonth()],n=t.getFullYear(),i=n+"/"+a+"/"+r;return i}}angular.module("readApp").directive("ratingStars",ratingStars);function ratingStars(){return{restrict:"EA",scope:{thisRating:"=rating"},templateUrl:"/main/directive/ratingStars/ratingStars.html"}}angular.module("readApp").directive("mainFooter",function(){return{restrict:"EA",templateUrl:"/main/directive/footer/footer.html"}});angular.module("readApp").directive("mainHeader",function(){return{restrict:"EA",templateUrl:"/main/directive/header/header.html"}});angular.module("readApp").controller("headerCtrl",headerCtrl);headerCtrl.$inject=["$location","authentication"];function headerCtrl(e,t){var r=this;r.currentPath=e.path();r.isLoggedIn=t.isLoggedIn();r.currentUser=t.currentUser();r.logout=function(){t.logout();e.path("/")}}angular.module("readApp").controller("discussCtrl",discussCtrl);discussCtrl.$inject=["talksData","$location","authentication"];function discussCtrl(e,t,r){var o=this;o.message="loading...";e.getTalks.success(function(e){o.message=e.length>0?"":"暂无数据";o.talksList=e}).error(function(){o.message="Sorry, something's gone wrong "});o.user=r.currentUser();o.isLoggedIn=r.isLoggedIn();o.currentPath=t.path()}angular.module("readApp").controller("personalCtrl",personalCtrl);personalCtrl.$inject=["authentication"];function personalCtrl(e){var t=this;t.title=t.currentUser.name+"的读书主页";t.currentUser=e.currentUser();t.whichTitle=function(){switch(window.event.target.text){case"读书主页":break;case"在读":t.title="我的在读（"+t.currentUser.name+"）";break;case"想读":t.title="我想读的书（"+t.currentUser.name+"）";break;case"读过":t.title="我读过的书（"+t.currentUser.name+"）";break;case"话题":t.title="我的话题（"+t.currentUser.name+"）";break}}}angular.module("readApp").controller("booksCtrl",booksCtrl);booksCtrl.$inject=["booksData","$modal","$location","authentication"];function booksCtrl(e,t,r,o){var a=this;a.message="loading...";e.getBooks.success(function(e){a.message=e.length>0?"":"暂无数据";a.books=e}).error(function(){a.message="Sorry, something's gone wrong "});a.user=o.currentUser();a.isLoggedIn=o.isLoggedIn();a.currentPath=r.path();a.popupForm=function(){var e=t.open({templateUrl:"../bookModal/bookModal.html",controller:"bookModalCtrl as vm",resolve:{viewData:function(){return{title:"新增推荐"}}}});e.result.then(function(e){a.books.push(e)})};a.removeBook=function(t){if(confirm("确定删除？")){e.removeBookById(t).success(function(){for(var e=0;e<a.books.length;e++){if(a.books[e]._id==t){a.books.splice(a.books.indexOf(a.books[e]),1)}}})}}}angular.module("readApp").controller("bookDetailCtrl",bookDetailCtrl);bookDetailCtrl.$inject=["$routeParams","booksData"];function bookDetailCtrl(e,t){var r=this,o=e.bookid;r.messagege="Loading...";t.getbookById(o).success(function(e){console.log(e);r.message=e.length>0?"":"暂无数据";r.book=e}).error(function(){r.message="Sorry, something's gone wrong "})}angular.module("readApp").controller("bookModalCtrl",bookModalCtrl);bookModalCtrl.$inject=["$modalInstance","viewData","booksData"];function bookModalCtrl(e,t,r){var o=this;o.viewData=t;o.formData={title:"",info:"",ISBN:"",tags:"",rating:"",brief:""};o.onSubmit=function(){o.formError="";if(!o.formData.title||!o.formData.info||!o.formData.ISBN||!o.formData.tags||!o.formData.rating||!o.formData.brief){o.formError="请完成所有栏目!";return false}else{o.doAddBook(o.formData);o.modal.cancel()}};o.doAddBook=function(e){r.addBook({title:e.title,info:e.info,ISBN:e.ISBN,tags:e.tags,rating:e.rating,brief:e.brief,img:e.img}).success(function(e){o.modal.close(e)}).error(function(){o.formError="添加失败，请再试一次"});return false};o.modal={close:function(t){e.close(t)},cancel:function(){e.dismiss("cancel")}}}angular.module("readApp").controller("registerCtrl",registerCtrl);registerCtrl.$inject=["$location","authentication"];function registerCtrl(e,t){var r=this;r.params={name:"",email:"",password:"",confirm_password:""};r.formError="";r.returnPage=e.search().page||"/";r.onSubmit=function(){if(!r.params.name||!r.params.email||!r.params.password||!r.params.confirm_password){r.formError="需要填完所有字段!";return false}else{r.doRegister()}};r.doRegister=function(){if(r.params.password!==r.params.confirm_password){r.formError="两次输入的密码不相同！"}else{t.register(r.params).error(function(e){r.formError=e}).then(function(){e.search("page",null);e.path(r.returnPage)})}}}angular.module("readApp").controller("loginCtrl",loginCtrl);loginCtrl.$inject=["$location","authentication"];function loginCtrl(e,t){var r=this;r.params={email:"",password:""};r.returnPage=e.search().page||"/";r.onSubmit=function(){r.formError="";if(!r.params.email||!r.params.password){r.formError="请输入邮箱和密码!";return false}else{r.doLogin()}};r.doLogin=function(){r.formError="";t.login(r.params).error(function(e){r.formError=e.message}).then(function(){e.search("page",null);e.path(r.returnPage)})}}