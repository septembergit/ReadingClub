var app=angular.module("readApp",["ngRoute","ngSanitize","ui.bootstrap"]);function config(t){t.when("/",{templateUrl:"home/home.html",controller:"homeCtrl",controllerAs:"vm"}).when("/about",{templateUrl:"about/about.html",controller:"aboutCtrl",caseInsensitiveMatch:true,controllerAs:"vm"}).when("/books",{templateUrl:"books/books.html",controller:"booksCtrl",caseInsensitiveMatch:true,controllerAs:"vm"}).when("/book/:bookid",{templateUrl:"bookDetail/bookDetail.html",controller:"bookDetailCtrl",caseInsensitiveMatch:true,controllerAs:"vm"}).when("/register",{templateUrl:"/auth/register/register.html",caseInsensitiveMatch:true,controller:"registerCtrl",controllerAs:"vm"}).when("/login",{templateUrl:"/auth/login/login.html",controller:"loginCtrl",controllerAs:"vm",caseInsensitiveMatch:true}).otherwise({redirectTo:"/"})}app.config(["$routeProvider",config]);angular.module("readApp").controller("homeCtrl",homeCtrl);homeCtrl.$inject=["topicData","userData"];function homeCtrl(t,r){var e=this;e.user=r;e.message="loading...";t.success(function(t){e.message=t.length>0?"":"暂无数据";e.data=t}).error(function(){e.message="Sorry, something's gone wrong "})}angular.module("readApp").service("topicData",topicData).service("booksData",booksData).service("userData",userData);topicData.$inject=["$http"];booksData.$inject=["$http","authentication"];function topicData(t){return t.get("/api/topics")}function booksData(t,r){var e=t.get("/api/books");var o=function(r){return t.get("/api/book/"+r)};var a=function(e){return t.post("/api/book",e,{headers:{Authorization:"Bearer "+r.getToken()}})};var n=function(e){return t.delete("/api/book/"+e,{Authorization:"Bearer "+r.getToken()})};return{getBooks:e,getbookById:o,addBook:a,removeBookById:n}}function userData(){return{userName:"用户readdata"}}angular.module("readApp").service("authentication",authentication);authentication.$inject=["$window","$http"];function authentication(t,r){var e=function(r){t.localStorage["read-token"]=r};var o=function(){return t.localStorage["read-token"]};var a=function(t){return r.post("/api/register",t).success(function(t){e(t.token)})};var n=function(t){return r.post("/api/login",t).success(function(t){e(t.token)})};var i=function(){t.localStorage.removeItem("read-token")};var l=function(){var r=o();if(r){var e=JSON.parse(t.atob(r.split(".")[1]));return e.exp>Date.now()/1e3}else{return false}};var s=function(){if(l()){var r=o(),e=JSON.parse(t.atob(r.split(".")[1]));return{email:e.email,name:e.name}}};return{saveToken:e,getToken:o,register:a,login:n,logout:i,isLoggedIn:l,currentUser:s}}angular.module("readApp").filter("formatDate",formatDate);function formatDate(){return function(t){var r=new Date(t),e=r.getDate(),o=["1","2","3","4","5","6","7","8","9","10","11","12"],a=o[r.getMonth()],n=r.getFullYear(),i=n+"/"+a+"/"+e;return i}}angular.module("readApp").directive("ratingStars",ratingStars);function ratingStars(){return{restrict:"EA",scope:{thisRating:"=rating"},templateUrl:"/main/directive/ratingStars/ratingStars.html"}}angular.module("readApp").directive("mainFooter",function(){return{restrict:"EA",templateUrl:"/main/directive/footer/footer.html"}});angular.module("readApp").directive("mainHeader",function(){return{restrict:"EA",templateUrl:"/main/directive/header/header.html",controller:"headerCtrl as navvm"}});angular.module("readApp").controller("headerCtrl",headerCtrl);headerCtrl.$inject=["$location","authentication"];function headerCtrl(t,r){var e=this;e.currentPath=t.path();e.isLoggedIn=r.isLoggedIn();e.currentUser=r.currentUser();e.logout=function(){r.logout();t.path("/")};e.witchLi=function(){}}angular.module("readApp").controller("aboutCtrl",aboutCtrl);function aboutCtrl(){var t=this;t.title="<b>ReadingClub</b>";t.user={userName:"用户关于"};t.bookList=["第一期   《失控》             -- 上海-aaaaaaa","第二期   《代码整洁之道》     -- 上海-aaaaaaa","第三期   《女人的起源》       -- 长沙-素情","第四期   《数学之美》         -- 广州_Watery.D.Lotus","第五期   《卓有成效的管理者》 -- 北京-卡萨布兰卡","第六期   《异类》             -- 上海-aaaaaaa","第七期   《设计心理学》       -- 北京--彦圣","第八期   《乌合之众》         -- 广州_Watery.D.Lotus & 上海_aaaaaaa","第九期   《国富论》           -- 上海-aaaaaaa","第十期   《少有人走的路》     -- 深圳-一路风景","第十一期 《程序员修炼之道》   -- aaaaaaa","第十二期 《性格色彩》         -- 上海_星空"]}angular.module("readApp").controller("booksCtrl",booksCtrl);booksCtrl.$inject=["booksData","$modal","$location","authentication"];function booksCtrl(t,r,e,o){var a=this;a.message="loading...";t.getBooks.success(function(t){a.message=t.length>0?"":"暂无数据";a.books=t}).error(function(){a.message="Sorry, something's gone wrong "});a.user=o.currentUser();a.isLoggedIn=o.isLoggedIn();a.currentPath=e.path();a.popupForm=function(){var t=r.open({templateUrl:"/bookModal/bookModal.html",controller:"bookModalCtrl as vm",resolve:{viewData:function(){return{title:"新增推荐"}}}});t.result.then(function(t){a.books.push(t)})};a.removeBook=function(r){if(confirm("确定删除？")){t.removeBookById(r).success(function(){for(var t=0;t<a.books.length;t++){if(a.books[t]._id==r){a.books.splice(a.books.indexOf(a.books[t]),1)}}})}}}angular.module("readApp").controller("bookDetailCtrl",bookDetailCtrl);bookDetailCtrl.$inject=["$routeParams","booksData","userData"];function bookDetailCtrl(t,r,e){var o=this;o.user=e;var a=t.bookid;r.getbookById(a).success(function(t){o.book=t}).error(function(){o.message="Sorry, something's gone wrong "})}angular.module("readApp").controller("bookModalCtrl",bookModalCtrl);bookModalCtrl.$inject=["$modalInstance","viewData","booksData"];function bookModalCtrl(t,r,e){var o=this;o.viewData=r;o.formData={title:"",info:"",ISBN:"",tags:"",rating:"",brief:""};o.onSubmit=function(){o.formError="";if(!o.formData.title||!o.formData.info||!o.formData.ISBN||!o.formData.tags||!o.formData.rating||!o.formData.brief){o.formError="请完成所有栏目!";return false}else{o.doAddBook(o.formData);return false}};o.doAddBook=function(t){e.addBook({title:t.title,info:t.info,ISBN:t.ISBN,tags:t.tags,rating:t.rating,brief:t.brief,img:t.img}).success(function(t){o.modal.close(t)}).error(function(){o.formError="添加失败，请再试一次"});return false};o.modal={close:function(r){t.close(r)},cancel:function(){t.dismiss("cancel")}}}angular.module("readApp").controller("registerCtrl",registerCtrl);registerCtrl.$inject=["$location","authentication"];function registerCtrl(t,r){var e=this;e.params={name:"",email:"",password:""};e.returnPage=t.search().page||"/";e.onSubmit=function(){e.formError="";if(!e.params.name||!e.params.email||!e.params.password){e.formError="需要填完所有字段!";return false}else{e.doRegister()}};e.doRegister=function(){e.formError="";r.register(e.params).error(function(t){e.formError=t}).then(function(){t.search("page",null);t.path(e.returnPage)})}}angular.module("readApp").controller("loginCtrl",loginCtrl);loginCtrl.$inject=["$location","authentication"];function loginCtrl(t,r){var e=this;e.params={email:"",password:""};e.returnPage=t.search().page||"/";e.onSubmit=function(){e.formError="";if(!e.params.email||!e.params.password){e.formError="请输入邮箱和密码!";return false}else{e.doLogin()}};e.doLogin=function(){e.formError="";r.login(e.params).error(function(t){e.formError=t.message}).then(function(){t.search("page",null);t.path(e.returnPage)})}}