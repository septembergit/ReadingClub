(function(){angular.module("readApp",["ngRoute","ngSanitize","ui.bootstrap"]);function e(e,o){e.when("/",{templateUrl:"home/home.html",controller:"homeCtrl",controllerAs:"vm"}).when("/about",{templateUrl:"about/about.html",controller:"aboutCtrl",caseInsensitiveMatch:true,controllerAs:"vm"}).when("/books",{templateUrl:"books/books.html",controller:"booksCtrl",caseInsensitiveMatch:true,controllerAs:"vm"}).when("/book/:bookid",{templateUrl:"bookDetail/bookDetail.html",controller:"bookDetailCtrl",caseInsensitiveMatch:true,controllerAs:"vm"}).when("/register",{templateUrl:"/auth/register/register.html",caseInsensitiveMatch:true,controller:"registerCtrl",controllerAs:"vm"}).when("/login",{templateUrl:"/auth/login/login.html",controller:"loginCtrl",controllerAs:"vm",caseInsensitiveMatch:true}).otherwise({redirectTo:"/"});o.html5Mode(true)}angular.module("readApp").config(["$routeProvider","$locationProvider",e])})();angular.module("readApp").controller("homeCtrl",homeCtrl);homeCtrl.$inject=["topicData","userData"];function homeCtrl(e,o){var t=this;t.message="loading...";e.success(function(e){t.message=e.length>0?"":"暂无数据";t.data=e}).error(function(e){t.message="Sorry, something's gone wrong "});t.user=o}angular.module("readApp").service("topicData",topicData).service("booksData",booksData).service("userData",userData);topicData.$inject=["$http"];function topicData(e){return e.get("/api/topics")}booksData.$inject=["$http","authentication"];function booksData(e,o){var t=e.get("/api/books");var r=function(o){return e.get("/api/book/"+o)};var a=function(t){return e.post("/api/book",t,{headers:{Authorization:"Bearer "+o.getToken()}})};var n=function(t){return e.delete("/api/book/"+t,{Authorization:"Bearer "+o.getToken()})};return{getBooks:t,getbookById:r,addBook:a,removeBookById:n}}function userData(){return{userName:"用户readdata"}}(function(){angular.module("readApp").service("authentication",e);e.$inject=["$window","$http"];function e(e,o){var t=function(o){e.localStorage["read-token"]=o};var r=function(){return e.localStorage["read-token"]};var a=function(e){return o.post("/api/register",e).success(function(e){t(e.token)})};var n=function(e){return o.post("/api/login",e).success(function(e){t(e.token)})};var i=function(){e.localStorage.removeItem("read-token")};var l=function(){var o=r();if(o){var t=JSON.parse(e.atob(o.split(".")[1]));return t.exp>Date.now()/1e3}else{return false}};var s=function(){if(l()){var o=r();var t=JSON.parse(e.atob(o.split(".")[1]));return{email:t.email,name:t.name}}};return{saveToken:t,getToken:r,register:a,login:n,logout:i,isLoggedIn:l,currentUser:s}}})();angular.module("readApp").filter("formatDate",formatDate);function formatDate(){return function(e){var o=new Date(e),t=o.getDate(),r=["1","2","3","4","5","6","7","8","9","10","11","12"],a=r[o.getMonth()],n=o.getFullYear(),i=n+"/"+a+"/"+t;return i}}angular.module("readApp").directive("ratingStars",ratingStars);function ratingStars(){return{restrict:"EA",scope:{thisRating:"=rating"},templateUrl:"/common/directive/ratingStars/ratingStars.template.html"}}(function(){angular.module("readApp").directive("footerNav",e);function e(){return{restrict:"EA",templateUrl:"/common/directive/footer/footer.html"}}})();(function(){angular.module("readApp").directive("headerNav",e);function e(){return{restrict:"EA",templateUrl:"/common/directive/header/header.html",controller:"headerCtrl as navvm"}}})();(function(){angular.module("readApp").controller("headerCtrl",e);e.$inject=["$location","authentication"];function e(e,o){var t=this;t.currentPath=e.path();t.isLoggedIn=o.isLoggedIn();t.currentUser=o.currentUser();t.logout=function(){o.logout();e.path("/")}}})();(function(){angular.module("readApp").controller("aboutCtrl",e);function e(){var e=this;e.title="<b>ReadingClub</b>";e.user={userName:"用户关于"};e.list=["第一期   《失控》             -- 上海-aaaaaaa","第二期   《代码整洁之道》     -- 上海-aaaaaaa","第三期   《女人的起源》       -- 长沙-素情","第四期   《数学之美》         -- 广州_Watery.D.Lotus","第五期   《卓有成效的管理者》 -- 北京-卡萨布兰卡","第六期   《异类》             -- 上海-aaaaaaa","第七期   《设计心理学》       -- 北京--彦圣","第八期   《乌合之众》         -- 广州_Watery.D.Lotus & 上海_aaaaaaa","第九期   《国富论》           -- 上海-aaaaaaa","第十期   《少有人走的路》     -- 深圳-一路风景","第十一期 《程序员修炼之道》   -- aaaaaaa","第十二期 《性格色彩》         -- 上海_星空"]}})();(function(){angular.module("readApp").controller("booksCtrl",e);e.$inject=["booksData","$modal","$location","authentication"];function e(e,o,t,r){var a=this;a.message="loading...";e.getBooks.success(function(e){a.message=e.length>0?"":"暂无数据";a.books=e}).error(function(e){console.log(e);a.message="Sorry, something's gone wrong "});a.user=r.currentUser();a.isLoggedIn=r.isLoggedIn();a.currentPath=t.path();a.popupForm=function(){var e=o.open({templateUrl:"/bookModal/bookModal.html",controller:"bookModalCtrl as vm",resolve:{viewData:function(){return{title:"新增推荐"}}}});e.result.then(function(e){a.books.push(e)})};a.removeBook=function(o){if(confirm("确定删除？")){e.removeBookById(o).success(function(){for(var e=0;e<a.books.length;e++){if(a.books[e]._id==o){a.books.splice(a.books.indexOf(a.books[e]),1)}}})}}}})();(function(){angular.module("readApp").controller("bookDetailCtrl",e);e.$inject=["$routeParams","booksData","$modal","userData"];function e(e,o,t,r){var a=this;var n=e.bookid;o.getbookById(n).success(function(e){a.book=e}).error(function(e){console.log(e);a.message="Sorry, something's gone wrong "});a.user=r}})();(function(){angular.module("readApp").controller("bookModalCtrl",e);e.$inject=["$modalInstance","viewData","booksData"];function e(e,o,t){var r=this;r.viewData=o;r.onSubmit=function(){r.formError="";if(!r.formData.title||!r.formData.rating||!r.formData.brief||!r.formData.info||!r.formData.ISBN){r.formError="请完成所有栏目!";return false}else{console.log(r.formData);r.doAddBook(r.formData);return false}};r.doAddBook=function(e){t.addBook({title:e.title,info:e.info,ISBN:e.ISBN,brief:e.brief,tags:e.tags,img:e.img,rating:e.rating}).success(function(e){console.log("success!");r.modal.close(e)}).error(function(e){r.formError="添加失败，请再试一次"});return false};r.modal={close:function(o){e.close(o)},cancel:function(){e.dismiss("cancel")}}}})();(function(){angular.module("readApp").controller("registerCtrl",e);e.$inject=["$location","authentication"];function e(e,o){var t=this;t.credentials={name:"",email:"",password:""};t.returnPage=e.search().page||"/";t.onSubmit=function(){t.formError="";if(!t.credentials.name||!t.credentials.email||!t.credentials.password){t.formError="需要填完所有字段!";return false}else{t.doRegister()}};t.doRegister=function(){t.formError="";o.register(t.credentials).error(function(e){t.formError=e}).then(function(){e.search("page",null);e.path(t.returnPage)})}}})();(function(){angular.module("readApp").controller("loginCtrl",e);e.$inject=["$location","authentication"];function e(e,o){var t=this;t.credentials={email:"",password:""};t.returnPage=e.search().page||"/";t.onSubmit=function(){t.formError="";if(!t.credentials.email||!t.credentials.password){t.formError="请输入邮箱和密码!";return false}else{t.doLogin()}};t.doLogin=function(){t.formError="";o.login(t.credentials).error(function(e){t.formError=e.message}).then(function(){e.search("page",null);e.path(t.returnPage)})}}})();